import { useState } from 'react';
import { invoke } from '@tauri-apps/api/core';
import {
    ShieldAlert,
    ShieldCheck,
    AlertTriangle,
    Play,
    FileCode,
    Target,
    Loader2,
    Copy,
    ChevronDown,
    ChevronRight
} from 'lucide-react';
import { GlassPanel } from './ui/GlassPanel';
import { PanelHeader } from './ui/PanelComponents';

interface Sink {
    sink_type: string;
    line: number;
    column: number;
    code_snippet: string;
    tainted_vars: string[];
}

interface PathNode {
    line: number;
    code: string;
    description: string;
}

interface AnalysisResult {
    success: boolean;
    status: 'Exploitable' | 'Safe' | 'Inconclusive' | 'NoSinksFound';
    sinks: Sink[];
    payload: string | null;
    explanation: string;
    attack_path: PathNode[];
    analysis_time_ms: number;
}

// Cross-file analysis types
interface CrossFilePathInfo {
    file_path: string;
    line: number;
    code: string;
    node_type: string;
    is_sink: boolean;
}

interface CrossFileFlowInfo {
    caller_file: string;
    caller_line: number;
    callee_file: string;
    callee_line: number;
    function_called: string;
    tainted_args: string[];
}

interface CrossFileResult {
    sinks_found: number;
    cross_file_flows: number;
    attack_path: CrossFilePathInfo[];
    flows: CrossFileFlowInfo[];
}

interface ExploitProverPanelProps {
    width?: number;
    activeFile?: string | null;
    fileContent?: string;
    workspacePath?: string;
}

export function ExploitProverPanel({ width = 350, activeFile, fileContent, workspacePath }: ExploitProverPanelProps) {
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [result, setResult] = useState<AnalysisResult | null>(null);
    const [error, setError] = useState<string | null>(null);
    const [expandedPath, setExpandedPath] = useState(true);
    const [expandedPayload, setExpandedPayload] = useState(true);

    // Cross-file analysis state
    const [crossFileResult, setCrossFileResult] = useState<CrossFileResult | null>(null);
    const [isCrossFileAnalyzing, setIsCrossFileAnalyzing] = useState(false);
    const [expandedCrossPath, setExpandedCrossPath] = useState(true);

    const runAnalysis = async () => {
        if (!fileContent) {
            setError('No file content to analyze. Open a Python file first.');
            return;
        }

        setIsAnalyzing(true);
        setError(null);
        setResult(null);

        try {
            const analysisResult = await invoke<AnalysisResult>('prove_exploitability', {
                request: {
                    source: fileContent,
                    target_line: null,
                    file_path: activeFile
                }
            });
            setResult(analysisResult);
        } catch (err) {
            setError(err instanceof Error ? err.message : String(err));
        } finally {
            setIsAnalyzing(false);
        }
    };

    const runCrossFileAnalysis = async () => {
        if (!activeFile || !workspacePath) {
            setError('Cross-file analysis requires workspace path. Use the file explorer first.');
            return;
        }

        setIsCrossFileAnalyzing(true);
        setError(null);
        setCrossFileResult(null);

        try {
            const crossResult = await invoke<CrossFileResult>('analyze_cross_file', {
                filePath: activeFile,
                workspacePath: workspacePath
            });
            setCrossFileResult(crossResult);
        } catch (err) {
            setError(err instanceof Error ? err.message : String(err));
        } finally {
            setIsCrossFileAnalyzing(false);
        }
    };

    const copyToClipboard = (text: string) => {
        navigator.clipboard.writeText(text);
    };

    const getStatusColor = (status: string) => {
        switch (status) {
            case 'Exploitable': return 'text-red-400 bg-red-500/10 border-red-500/30';
            case 'Safe': return 'text-green-400 bg-green-500/10 border-green-500/30';
            case 'Inconclusive': return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
            case 'NoSinksFound': return 'text-blue-400 bg-blue-500/10 border-blue-500/30';
            default: return 'text-gray-400 bg-gray-500/10 border-gray-500/30';
        }
    };

    const getStatusIcon = (status: string) => {
        switch (status) {
            case 'Exploitable': return <ShieldAlert className="text-red-400" size={20} />;
            case 'Safe': return <ShieldCheck className="text-green-400" size={20} />;
            case 'Inconclusive': return <AlertTriangle className="text-yellow-400" size={20} />;
            case 'NoSinksFound': return <FileCode className="text-blue-400" size={20} />;
            default: return <Target className="text-gray-400" size={20} />;
        }
    };

    return (
        <GlassPanel width={width}>
            <PanelHeader
                title="Exploit Prover"
                icon={<ShieldAlert size={14} />}
                iconColor="#ff4444"
            />

            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                {/* Analyze Button */}
                <button
                    onClick={runAnalysis}
                    disabled={isAnalyzing || !fileContent}
                    className={`w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold text-sm transition-all ${isAnalyzing || !fileContent
                        ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed'
                        : 'bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white shadow-lg shadow-red-500/20'
                        }`}
                >
                    {isAnalyzing ? (
                        <>
                            <Loader2 className="animate-spin" size={18} />
                            Analyzing...
                        </>
                    ) : (
                        <>
                            <Play size={18} />
                            Prove Exploitability
                        </>
                    )}
                </button>

                {/* Cross-File Analysis Button */}
                <button
                    onClick={runCrossFileAnalysis}
                    disabled={isCrossFileAnalyzing || !activeFile || !workspacePath}
                    className={`w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-bold text-xs transition-all ${isCrossFileAnalyzing || !activeFile || !workspacePath
                        ? 'bg-gray-600/30 text-gray-500 cursor-not-allowed'
                        : 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white shadow-lg shadow-purple-500/20'
                        }`}
                >
                    {isCrossFileAnalyzing ? (
                        <>
                            <Loader2 className="animate-spin" size={14} />
                            Cross-File Scanning...
                        </>
                    ) : (
                        <>
                            <Target size={14} />
                            Cross-File Analysis
                        </>
                    )}
                </button>

                {/* Current File */}
                {activeFile && (
                    <div className="text-xs text-gray-500 truncate">
                        Target: {activeFile.split(/[/\\]/).pop()}
                    </div>
                )}

                {/* Error Display */}
                {error && (
                    <div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <div className="flex items-center gap-2 text-red-400 text-sm font-bold mb-1">
                            <AlertTriangle size={14} />
                            Analysis Error
                        </div>
                        <p className="text-xs text-red-300/80">{error}</p>
                    </div>
                )}

                {/* Results */}
                {result && (
                    <div className="space-y-4">
                        {/* Status Card */}
                        <div className={`p-4 rounded-lg border ${getStatusColor(result.status)}`}>
                            <div className="flex items-center gap-3 mb-2">
                                {getStatusIcon(result.status)}
                                <span className="font-bold text-lg">{result.status.replace(/([A-Z])/g, ' $1').trim()}</span>
                            </div>
                            <p className="text-xs opacity-80">{result.explanation.split('\n')[0]}</p>
                            <div className="mt-2 text-[10px] opacity-60">
                                Analysis completed in {result.analysis_time_ms}ms
                            </div>
                        </div>

                        {/* Detected Sinks */}
                        {result.sinks.length > 0 && (
                            <div className="space-y-2">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    Detected Sinks ({result.sinks.length})
                                </h3>
                                {result.sinks.map((sink, i) => (
                                    <div key={i} className="p-3 bg-black/20 rounded border border-white/5">
                                        <div className="flex items-center justify-between mb-1">
                                            <span className="text-xs font-mono text-red-400">
                                                Line {sink.line}
                                            </span>
                                            <span className="text-[10px] px-2 py-0.5 bg-red-500/20 text-red-300 rounded">
                                                {sink.sink_type.replace('Injection', ' Injection')}
                                            </span>
                                        </div>
                                        <code className="text-[11px] font-mono text-gray-300 block truncate">
                                            {sink.code_snippet}
                                        </code>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Attack Path */}
                        {result.attack_path.length > 0 && (
                            <div className="space-y-2">
                                <button
                                    onClick={() => setExpandedPath(!expandedPath)}
                                    className="flex items-center gap-1 text-xs font-bold text-gray-400 uppercase tracking-wider hover:text-white transition-colors"
                                >
                                    {expandedPath ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                    Attack Path ({result.attack_path.length} nodes)
                                </button>
                                {expandedPath && (
                                    <div className="space-y-1 pl-2 border-l-2 border-red-500/30">
                                        {result.attack_path.map((node, i) => (
                                            <div key={i} className="p-2 bg-black/20 rounded">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-[10px] font-mono text-yellow-400">
                                                        #{node.line}
                                                    </span>
                                                    <span className="text-[10px] text-gray-500">
                                                        {node.description}
                                                    </span>
                                                </div>
                                                <code className="text-[10px] font-mono text-gray-300 block">
                                                    {node.code}
                                                </code>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Payload */}
                        {result.payload && (
                            <div className="space-y-2">
                                <button
                                    onClick={() => setExpandedPayload(!expandedPayload)}
                                    className="flex items-center gap-1 text-xs font-bold text-gray-400 uppercase tracking-wider hover:text-white transition-colors"
                                >
                                    {expandedPayload ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                    Proof-of-Concept Payload
                                </button>
                                {expandedPayload && (
                                    <div className="relative">
                                        <button
                                            onClick={() => copyToClipboard(result.payload!)}
                                            className="absolute top-2 right-2 p-1.5 bg-white/10 hover:bg-white/20 rounded transition-colors"
                                            title="Copy to clipboard"
                                        >
                                            <Copy size={12} />
                                        </button>
                                        <pre className="p-3 bg-black/40 rounded border border-white/10 text-[10px] font-mono text-green-300 overflow-x-auto custom-scrollbar max-h-64">
                                            {result.payload}
                                        </pre>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}

                {/* Cross-File Analysis Results */}
                {crossFileResult && (
                    <div className="space-y-4">
                        {/* Cross-File Summary Card */}
                        <div className="p-4 rounded-lg border bg-purple-500/10 border-purple-500/30">
                            <div className="flex items-center gap-3 mb-2">
                                <Target className="text-purple-400" size={20} />
                                <span className="font-bold text-lg text-purple-300">
                                    Cross-File Analysis
                                </span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="p-2 bg-black/20 rounded">
                                    <span className="text-gray-500">Sinks Found: </span>
                                    <span className="text-white font-bold">{crossFileResult.sinks_found}</span>
                                </div>
                                <div className="p-2 bg-black/20 rounded">
                                    <span className="text-gray-500">Cross-File Flows: </span>
                                    <span className="text-purple-400 font-bold">{crossFileResult.cross_file_flows}</span>
                                </div>
                            </div>
                        </div>

                        {/* Cross-File Attack Path */}
                        {crossFileResult.attack_path.length > 0 && (
                            <div className="space-y-2">
                                <button
                                    onClick={() => setExpandedCrossPath(!expandedCrossPath)}
                                    className="flex items-center gap-1 text-xs font-bold text-purple-400 uppercase tracking-wider hover:text-white transition-colors"
                                >
                                    {expandedCrossPath ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                    Multi-File Attack Path ({crossFileResult.attack_path.length} nodes)
                                </button>
                                {expandedCrossPath && (
                                    <div className="space-y-1 pl-2 border-l-2 border-purple-500/30">
                                        {crossFileResult.attack_path.map((node, i) => (
                                            <div key={i} className={`p-2 rounded ${node.is_sink ? 'bg-red-500/10 border border-red-500/20' : 'bg-black/20'}`}>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-[10px] font-mono text-cyan-400 truncate max-w-[120px]">
                                                        {node.file_path.split(/[/\\]/).pop()}
                                                    </span>
                                                    <span className="text-[10px] font-mono text-yellow-400">
                                                        #{node.line}
                                                    </span>
                                                    {node.is_sink && (
                                                        <span className="text-[8px] px-1 py-0.5 bg-red-500/20 text-red-300 rounded">
                                                            SINK
                                                        </span>
                                                    )}
                                                </div>
                                                <code className="text-[10px] font-mono text-gray-300 block truncate">
                                                    {node.code}
                                                </code>
                                                <div className="text-[9px] text-gray-500 mt-1">
                                                    {node.node_type}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Cross-File Flows */}
                        {crossFileResult.flows.length > 0 && (
                            <div className="space-y-2">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    Tainted Data Flows ({crossFileResult.flows.length})
                                </h3>
                                {crossFileResult.flows.map((flow, i) => (
                                    <div key={i} className="p-3 bg-black/20 rounded border border-purple-500/20">
                                        <div className="flex items-center gap-1 text-[10px] mb-2">
                                            <span className="text-cyan-400 truncate max-w-[80px]">
                                                {flow.caller_file.split(/[/\\]/).pop()}
                                            </span>
                                            <span className="text-gray-500">→</span>
                                            <span className="text-purple-400 font-bold">
                                                {flow.function_called}()
                                            </span>
                                            <span className="text-gray-500">→</span>
                                            <span className="text-cyan-400 truncate max-w-[80px]">
                                                {flow.callee_file.split(/[/\\]/).pop()}
                                            </span>
                                        </div>
                                        <div className="text-[9px] text-gray-500">
                                            Tainted args: <span className="text-red-400">{flow.tainted_args.join(', ')}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}

                {/* Empty State */}
                {!result && !crossFileResult && !error && !isAnalyzing && !isCrossFileAnalyzing && (
                    <div className="text-center py-8 text-gray-500">
                        <ShieldAlert size={48} className="mx-auto mb-4 opacity-30" />
                        <p className="text-sm font-medium mb-1">No Analysis Yet</p>
                        <p className="text-xs opacity-70">
                            Open a Python file and click "Prove Exploitability"
                        </p>
                    </div>
                )}
            </div>
        </GlassPanel>
    );
}
