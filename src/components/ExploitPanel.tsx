import { useState, useEffect, useRef } from 'react';
import { invoke } from '@tauri-apps/api/core';
import { useHackerMode } from '../contexts/HackerModeContext';
import { AttackVisualization } from './AttackVisualization';
import { Play, AlertTriangle, ShieldCheck, Terminal, Crosshair, Bug, SkipForward, Pause, RefreshCw } from 'lucide-react';

interface ExploitPayload {
    name: string;
    attack_type: string;
    payload: string;
    description: string;
    target_pattern: string;
}

interface AttackStep {
    step_number: number;
    action: string;
    result: string;
    status: 'Success' | 'Failed' | 'Blocked';
}

interface AttackResult {
    success: boolean;
    attack_type: string;
    payload_used: string;
    impact_description: string;
    data_exposed?: string;
    attack_chain: AttackStep[];
    risk_score: number;
    cwe: string;
    mitigation: string;
}

interface ExploitPanelProps {
    activeFile?: string | null;
}

export function ExploitPanel({ activeFile }: ExploitPanelProps) {
    const { isHackerMode, playSound } = useHackerMode();
    const [payloads, setPayloads] = useState<ExploitPayload[]>([]);
    const [selectedPayloadIndex, setSelectedPayloadIndex] = useState<number>(0);
    const [targetCode, setTargetCode] = useState<string>('');
    const [isScanning, setIsScanning] = useState(false);
    const [result, setResult] = useState<AttackResult | null>(null);
    const [customPayload, setCustomPayload] = useState('');

    // Playback state
    const [currentStepIndex, setCurrentStepIndex] = useState(-1);
    const [isPlaying, setIsPlaying] = useState(false);
    const playbackTimerRef = useRef<number | null>(null);

    // Auto-load active file content
    useEffect(() => {
        if (activeFile && (activeFile.endsWith('.js') || activeFile.endsWith('.py') || activeFile.endsWith('.ts') || activeFile.endsWith('.rs'))) {
            invoke<string>('read_file', { path: activeFile })
                .then(content => {
                    if (content) setTargetCode(content);
                })
                .catch((err: unknown) => console.error("Failed to read file for exploit:", err));
        }
    }, [activeFile]);

    // Fetch payloads on mount
    useEffect(() => {
        invoke<{ payloads: ExploitPayload[] }>('get_exploit_payloads')
            .then(data => setPayloads(data.payloads))
            .catch(console.error);

        // Default vulnerable code example if no file loaded
        if (!activeFile && !targetCode) {
            setTargetCode(`def login(username, password):
    # VULNERABLE CODE
    query = f"SELECT * FROM users WHERE user='{username}' AND pass='{password}'"
    cursor.execute(query)
    return cursor.fetchone()`);
        }
    }, []);

    // Playback Effect
    useEffect(() => {
        if (isPlaying && result) {
            playbackTimerRef.current = window.setInterval(() => {
                setCurrentStepIndex(prev => {
                    if (prev >= result.attack_chain.length - 1) {
                        setIsPlaying(false);
                        if (playbackTimerRef.current) clearInterval(playbackTimerRef.current);

                        // Final result sound
                        if (result.success) {
                            playSound('playSuccess');
                        } else {
                            playSound('playFailure');
                        }

                        return prev;
                    }
                    playSound('playClick'); // Sound for each step
                    return prev + 1;
                });
            }, 1000); // 1 second per step
        } else {
            if (playbackTimerRef.current) {
                clearInterval(playbackTimerRef.current);
                playbackTimerRef.current = null;
            }
        }

        return () => {
            if (playbackTimerRef.current) {
                clearInterval(playbackTimerRef.current);
            }
        };
    }, [isPlaying, result, playSound]);

    const handleExecute = async () => {
        setIsScanning(true);
        setResult(null);
        setCurrentStepIndex(-1);
        setIsPlaying(false);

        playSound('playPowerUp'); // Start sound

        try {
            // Artificial delay for dramatic effect
            await new Promise(resolve => setTimeout(resolve, 1500));

            const attackResult = await invoke<AttackResult>('run_exploit_simulation', {
                code: targetCode,
                payloadIndex: selectedPayloadIndex
            });

            setResult(attackResult);
            // Auto-play on fresh execute
            setCurrentStepIndex(-1);
            setIsPlaying(true);
        } catch (err) {
            console.error(err);
        } finally {
            setIsScanning(false);
        }
    };

    return (
        <div className={`h-full flex flex-col ${isHackerMode ? 'font-mono' : ''}`}>
            {/* Header */}
            <div className={`p-3 border-b flex items-center justify-between ${isHackerMode ? 'border-[#00ff41]/30 bg-[#0d1117]' : 'border-[#2D2D30] bg-[#252526]'}`}>
                <div className="flex items-center gap-2">
                    <Crosshair size={18} className={isHackerMode ? 'text-[#ff0040]' : 'text-red-400'} />
                    <span className={`font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}`}>EXPLOIT ATTACK SIMULATOR</span>
                </div>
                {isHackerMode && <span className="text-xs text-[#ff0040] animate-pulse">‚óè LIVE FIRE MODE</span>}
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-6">

                {/* 1. Target & Payload Selection */}
                <div className="grid grid-cols-12 gap-4">
                    <div className="col-span-8 space-y-2">
                        <label className={`text-xs font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}`}>TARGET CODE SOURCE</label>
                        <div className={`relative border rounded-md overflow-hidden ${isHackerMode ? 'border-[#00ff41]/30' : 'border-[#3C3C3C]'}`}>
                            <textarea
                                value={targetCode}
                                onChange={(e) => setTargetCode(e.target.value)}
                                className={`w-full h-32 p-3 text-sm font-mono outline-none resize-none ${isHackerMode ? 'bg-[#0a0a0a] text-[#00ff41]' : 'bg-[#1E1E1E] text-[#D4D4D4]'
                                    }`}
                                spellCheck={false}
                            />
                            {isHackerMode && <div className="absolute top-0 right-0 p-1 text-[10px] bg-[#ff0040] text-black font-bold">VULNERABLE</div>}
                        </div>
                    </div>

                    <div className="col-span-4 space-y-2 flex flex-col">
                        <label className={`text-xs font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}`}>ATTACK VECTOR</label>
                        <div className="flex-1 flex flex-col gap-2">
                            <select
                                className={`w-full p-2 text-sm rounded border outline-none ${isHackerMode
                                    ? 'bg-[#0a0a0a] text-[#00ff41] border-[#00ff41]/50 focus:shadow-[0_0_10px_#00ff41]'
                                    : 'bg-[#3C3C3C] text-[#CCCCCC] border-[#3C3C3C]'
                                    }`}
                                value={selectedPayloadIndex}
                                onChange={(e) => setSelectedPayloadIndex(Number(e.target.value))}
                            >
                                {payloads.map((p, i) => (
                                    <option key={i} value={i}>{p.attack_type}: {p.name}</option>
                                ))}
                            </select>

                            <div className={`flex-1 p-3 rounded border text-xs overflow-y-auto ${isHackerMode ? 'bg-[#0d1117] border-[#00ff41]/30 text-[#00ff41]/80' : 'bg-[#252526] border-[#3C3C3C] text-[#858585]'
                                }`}>
                                <div className="font-bold mb-1">PAYLOAD:</div>
                                <code className="break-all">{payloads[selectedPayloadIndex]?.payload}</code>
                                <div className="mt-2 font-bold mb-1">DESCRIPTION:</div>
                                <p>{payloads[selectedPayloadIndex]?.description}</p>
                            </div>

                            <button
                                onClick={handleExecute}
                                disabled={isScanning}
                                className={`w-full py-2 px-4 rounded font-bold flex items-center justify-center gap-2 transition-all ${isScanning ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'
                                    } ${isHackerMode
                                        ? 'bg-[#ff0040] text-black shadow-[0_0_15px_#ff0040] hover:bg-[#ff3366]'
                                        : 'bg-[#C53030] text-white hover:bg-[#E53E3E]'
                                    }`}
                            >
                                {isScanning ? (
                                    <>Running Exploit...</>
                                ) : (
                                    <>
                                        <Play size={16} fill="currentColor" />
                                        EXECUTE ATTACK
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>

                {/* 2. Attack Visualization & Controls */}
                <div className="space-y-2">
                    <div className="flex items-center justify-between">
                        <label className={`text-xs font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}`}>REAL-TIME ATTACK VISUALIZATION</label>
                        {result && (
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => {
                                        setIsPlaying(!isPlaying);
                                    }}
                                    className={`p-1 rounded hover:bg-white/10 ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    title={isPlaying ? "Pause" : "Play"}
                                >
                                    {isPlaying ? <Pause size={16} /> : <Play size={16} />}
                                </button>
                                <button
                                    onClick={() => {
                                        if (result && currentStepIndex < result.attack_chain.length - 1) {
                                            setCurrentStepIndex(prev => prev + 1);
                                            setIsPlaying(false);
                                        }
                                    }}
                                    className={`p-1 rounded hover:bg-white/10 ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    disabled={!result || currentStepIndex >= result.attack_chain.length - 1}
                                    title="Next Step"
                                >
                                    <SkipForward size={16} />
                                </button>
                                <button
                                    onClick={() => {
                                        setCurrentStepIndex(-1);
                                        setIsPlaying(true);
                                    }}
                                    className={`p-1 rounded hover:bg-white/10 ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    title="Replay"
                                >
                                    <RefreshCw size={16} />
                                </button>
                            </div>
                        )}
                        {result && !isPlaying && (
                            <span className={`text-xs font-mono ml-4 ${result.success ? 'text-red-500' : 'text-green-500'}`}>
                                STATUS: {result.success ? 'EXPLOIT SUCCESSFUL' : 'ATTACK MITIGATED'}
                            </span>
                        )}
                    </div>
                    {/* Pass currentStepIndex to visualization to only show up to that step */}
                    <AttackVisualization result={result} isScanning={isScanning} currentStepIndex={currentStepIndex} />
                </div>

                {/* 3. Detailed Results */}
                {result && (
                    <div className={`border rounded-md overflow-hidden ${isHackerMode ? 'border-[#00ff41]/30' : 'border-[#2D2D30]'}`}>
                        <div className={`p-2 border-b flex items-center gap-2 ${isHackerMode ? 'bg-[#0d1117] border-[#00ff41]/30' : 'bg-[#252526] border-[#2D2D30]'
                            }`}>
                            <Terminal size={14} className={isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'} />
                            <span className={`text-xs font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}`}>ATTACK LOG</span>
                        </div>

                        <div className={`p-4 font-mono text-sm space-y-4 ${isHackerMode ? 'bg-[#0a0a0a]' : 'bg-[#1E1E1E]'}`}>

                            {/* Attack Steps */}
                            <div className="space-y-2">
                                {result.attack_chain.map((step, i) => (
                                    <div key={i} className="flex gap-3 items-start animate-fade-in" style={{ animationDelay: `${i * 100}ms` }}>
                                        <span className={`text-xs mt-0.5 ${isHackerMode ? 'text-[#00ff41]/50' : 'text-[#858585]'}`}>
                                            [{String(step.step_number).padStart(2, '0')}]
                                        </span>
                                        <div>
                                            <div className={isHackerMode ? 'text-[#00ff41]' : 'text-[#CCCCCC]'}>
                                                {step.action}
                                            </div>
                                            <div className={`text-xs mt-1 ${step.status === 'Success'
                                                ? (isHackerMode ? 'text-[#ff0040]' : 'text-red-400')
                                                : 'text-green-400'
                                                }`}>
                                                &gt; {step.result}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Impact Analysis */}
                            {result.success && (
                                <div className={`mt-4 p-3 border border-dashed rounded ${isHackerMode ? 'border-[#ff0040] bg-[#ff0040]/10' : 'border-red-900 bg-red-900/10'
                                    }`}>
                                    <div className={`flex items-center gap-2 mb-2 font-bold ${isHackerMode ? 'text-[#ff0040]' : 'text-red-400'}`}>
                                        <Bug size={16} />
                                        IMPACT ANALYSIS
                                    </div>
                                    <div className={`text-xs space-y-1 ${isHackerMode ? 'text-[#ff0040]/80' : 'text-red-300'}`}>
                                        <p>TYPE: {result.attack_type}</p>
                                        <p>IMPACT: {result.impact_description}</p>
                                        {result.data_exposed && <p>DATA EXPOSED: {result.data_exposed}</p>}
                                        <p>CWE: {result.cwe}</p>
                                    </div>
                                </div>
                            )}

                            {/* Mitigation */}
                            <div className={`mt-2 p-3 border border-dashed rounded ${isHackerMode ? 'border-[#00ff41] bg-[#00ff41]/10' : 'border-green-900 bg-green-900/10'
                                }`}>
                                <div className={`flex items-center gap-2 mb-2 font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-green-400'}`}>
                                    <ShieldCheck size={16} />
                                    REMEDIATION
                                </div>
                                <div className={`text-xs ${isHackerMode ? 'text-[#00ff41]/80' : 'text-green-300'}`}>
                                    {result.mitigation}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}
