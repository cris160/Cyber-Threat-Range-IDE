import { useState, useEffect, useRef } from 'react';
import { invoke } from '@tauri-apps/api/core';
import { useHackerMode } from '../contexts/HackerModeContext';
import { GlassPanel } from './ui/GlassPanel';
import { PanelHeader, PanelButton } from './ui/PanelComponents';
import { AttackVisualization } from './AttackVisualization';
import { Play, AlertTriangle, ShieldCheck, Terminal, Crosshair, Bug, SkipForward, Pause, RefreshCw } from 'lucide-react';

interface ExploitPayload {
    name: string;
    attack_type: string;
    payload: string;
    description: string;
    target_pattern: string;
}

interface AttackStep {
    step_number: number;
    action: string;
    result: string;
    status: 'Success' | 'Failed' | 'Blocked';
}

interface AttackResult {
    success: boolean;
    attack_type: string;
    payload_used: string;
    impact_description: string;
    data_exposed?: string;
    attack_chain: AttackStep[];
    risk_score: number;
    cwe: string;
    mitigation: string;
}

interface ExploitPanelProps {
    activeFile?: string | null;
}

export function ExploitPanel({ activeFile }: ExploitPanelProps) {
    const { isHackerMode, playSound } = useHackerMode();
    const [payloads, setPayloads] = useState<ExploitPayload[]>([]);
    const [selectedPayloadIndex, setSelectedPayloadIndex] = useState<number>(0);
    const [targetCode, setTargetCode] = useState<string>('');
    const [isScanning, setIsScanning] = useState(false);
    const [result, setResult] = useState<AttackResult | null>(null);
    const [customPayload, setCustomPayload] = useState('');

    // Playback state
    const [currentStepIndex, setCurrentStepIndex] = useState(-1);
    const [isPlaying, setIsPlaying] = useState(false);
    const playbackTimerRef = useRef<number | null>(null);

    // Auto-load active file content
    useEffect(() => {
        if (activeFile && (activeFile.endsWith('.js') || activeFile.endsWith('.py') || activeFile.endsWith('.ts') || activeFile.endsWith('.rs'))) {
            invoke<string>('read_file', { path: activeFile })
                .then(content => {
                    if (content) setTargetCode(content);
                })
                .catch((err: unknown) => console.error("Failed to read file for exploit:", err));
        }
    }, [activeFile]);

    // Fetch payloads on mount
    useEffect(() => {
        invoke<{ payloads: ExploitPayload[] }>('get_exploit_payloads')
            .then(data => setPayloads(data.payloads))
            .catch(console.error);

        // Default vulnerable code example if no file loaded
        if (!activeFile && !targetCode) {
            setTargetCode(`def login(username, password):
    # VULNERABLE CODE
    query = f"SELECT * FROM users WHERE user='{username}' AND pass='{password}'"
    cursor.execute(query)
    return cursor.fetchone()`);
        }
    }, []);

    // Playback Effect
    useEffect(() => {
        if (isPlaying && result) {
            playbackTimerRef.current = window.setInterval(() => {
                setCurrentStepIndex(prev => {
                    if (prev >= result.attack_chain.length - 1) {
                        setIsPlaying(false);
                        if (playbackTimerRef.current) clearInterval(playbackTimerRef.current);

                        // Final result sound
                        if (result.success) {
                            playSound('playSuccess');
                        } else {
                            playSound('playFailure');
                        }

                        return prev;
                    }
                    playSound('playClick'); // Sound for each step
                    return prev + 1;
                });
            }, 1000); // 1 second per step
        } else {
            if (playbackTimerRef.current) {
                clearInterval(playbackTimerRef.current);
                playbackTimerRef.current = null;
            }
        }

        return () => {
            if (playbackTimerRef.current) {
                clearInterval(playbackTimerRef.current);
            }
        };
    }, [isPlaying, result, playSound]);

    const handleExecute = async () => {
        setIsScanning(true);
        setResult(null);
        setCurrentStepIndex(-1);
        setIsPlaying(false);

        playSound('playPowerUp'); // Start sound

        try {
            // Artificial delay for dramatic effect
            await new Promise(resolve => setTimeout(resolve, 1500));

            const attackResult = await invoke<AttackResult>('run_exploit_simulation', {
                code: targetCode,
                payloadIndex: selectedPayloadIndex
            });

            setResult(attackResult);
            // Auto-play on fresh execute
            setCurrentStepIndex(-1);
            setIsPlaying(true);
        } catch (err) {
            console.error(err);
        } finally {
            setIsScanning(false);
        }
    };

    return (
        <GlassPanel>
            {/* Header */}
            <PanelHeader
                title="Exploit Simulator"
                icon={<Crosshair size={14} />}
                iconColor={isHackerMode ? '#ff0040' : '#ef4444'}
                actions={isHackerMode && (
                    <span className="text-[10px] text-[#ff0040] font-bold animate-pulse px-2 py-0.5 border border-[#ff0040]/30 rounded bg-[#ff0040]/10">
                        LIVE FIRE
                    </span>
                )}
            />

            <div className="flex-1 overflow-y-auto p-3 space-y-4 custom-scrollbar" style={{ scrollbarWidth: 'thin', scrollbarColor: '#424242 transparent' }}>

                {/* 1. Target & Payload Selection */}
                <div className="flex flex-col gap-4">
                    {/* Target Code */}
                    <div className="space-y-1.5">
                        <label className={`text-[10px] font-bold uppercase tracking-wider ${isHackerMode ? 'text-[#00ff41]' : 'text-[#888]'}`}>Target Code Source</label>
                        <div className={`relative border rounded-lg overflow-hidden transition-colors ${isHackerMode ? 'border-[#00ff41]/30 bg-[#0a0a0a]/50' : 'border-white/10 bg-black/20'}`}>
                            <textarea
                                value={targetCode}
                                onChange={(e) => setTargetCode(e.target.value)}
                                className={`w-full h-32 p-3 text-[11px] font-mono outline-none resize-none bg-transparent ${isHackerMode ? 'text-[#00ff41]' : 'text-[#ccc]'}`}
                                spellCheck={false}
                            />
                            {isHackerMode && (
                                <div className="absolute top-0 right-0 px-1.5 py-0.5 text-[9px] bg-[#ff0040] text-black font-bold rounded-bl-md">
                                    VULNERABLE
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Attack Vector */}
                    <div className="space-y-2">
                        <label className={`text-[10px] font-bold uppercase tracking-wider ${isHackerMode ? 'text-[#00ff41]' : 'text-[#888]'}`}>Attack Vector</label>
                        <div className="flex flex-col gap-2">
                            <select
                                className={`w-full p-2 text-[11px] rounded-md border outline-none transition-all ${isHackerMode
                                    ? 'bg-[#0a0a0a] text-[#00ff41] border-[#00ff41]/50 focus:shadow-[0_0_10px_#00ff41]/20'
                                    : 'bg-white/5 text-[#ccc] border-white/10 focus:border-[#00c8b4]/50'
                                    }`}
                                value={selectedPayloadIndex}
                                onChange={(e) => setSelectedPayloadIndex(Number(e.target.value))}
                            >
                                {payloads.map((p, i) => (
                                    <option key={i} value={i} className="bg-[#1e1e1e]">{p.attack_type}: {p.name}</option>
                                ))}
                            </select>

                            <div className={`flex-1 p-3 rounded-md border text-[11px] overflow-y-auto transition-colors ${isHackerMode ? 'bg-[#0d1117] border-[#00ff41]/30 text-[#00ff41]/80' : 'bg-black/20 border-white/5 text-[#888]'}`}>
                                <div className="font-bold mb-1 text-[9px] uppercase tracking-wider opacity-70">PAYLOAD PREVIEW</div>
                                <code className="break-all block p-2 bg-black/20 rounded font-mono text-[10px] mb-2 border border-white/5">
                                    {payloads[selectedPayloadIndex]?.payload}
                                </code>
                                <div className="font-bold mb-1 text-[9px] uppercase tracking-wider opacity-70">DESCRIPTION</div>
                                <p className="leading-relaxed opacity-90">{payloads[selectedPayloadIndex]?.description}</p>
                            </div>

                            <PanelButton
                                onClick={handleExecute}
                                disabled={isScanning}
                                className={`w-full justify-center py-2 ${isHackerMode ? 'hover:bg-[#ff3366] border-[#ff0040]' : ''}`}
                                variant={isHackerMode ? 'secondary' : 'primary'}
                                style={isHackerMode ? { backgroundColor: '#ff0040', color: 'black', boxShadow: '0 0 15px rgba(255, 0, 64, 0.3)' } : {}}
                            >
                                {isScanning ? (
                                    <span className="flex items-center gap-2">
                                        <span className="w-3 h-3 border-2 border-t-transparent border-current rounded-full animate-spin" />
                                        Wait...
                                    </span>
                                ) : (
                                    <span className="flex items-center gap-2 font-bold tracking-wide">
                                        <Play size={14} fill="currentColor" />
                                        EXECUTE ATTACK
                                    </span>
                                )}
                            </PanelButton>
                        </div>
                    </div>
                </div>

                {/* 2. Attack Visualization & Controls */}
                <div className="space-y-2 pt-2 border-t border-white/5">
                    <div className="flex items-center justify-between">
                        <label className={`text-[10px] font-bold uppercase tracking-wider ${isHackerMode ? 'text-[#00ff41]' : 'text-[#888]'}`}>Real-Time Visualization</label>
                        {result && (
                            <div className="flex items-center gap-1 bg-black/20 p-0.5 rounded-md border border-white/5">
                                <button
                                    onClick={() => setIsPlaying(!isPlaying)}
                                    className={`p-1 rounded hover:bg-white/10 transition-colors ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    title={isPlaying ? "Pause" : "Play"}
                                >
                                    {isPlaying ? <Pause size={12} /> : <Play size={12} />}
                                </button>
                                <button
                                    onClick={() => {
                                        if (result && currentStepIndex < result.attack_chain.length - 1) {
                                            setCurrentStepIndex(prev => prev + 1);
                                            setIsPlaying(false);
                                        }
                                    }}
                                    className={`p-1 rounded hover:bg-white/10 transition-colors ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    disabled={!result || currentStepIndex >= result.attack_chain.length - 1}
                                    title="Next Step"
                                >
                                    <SkipForward size={12} />
                                </button>
                                <button
                                    onClick={() => {
                                        setCurrentStepIndex(-1);
                                        setIsPlaying(true);
                                    }}
                                    className={`p-1 rounded hover:bg-white/10 transition-colors ${isHackerMode ? 'text-[#00ff41]' : 'text-white'}`}
                                    title="Replay"
                                >
                                    <RefreshCw size={12} />
                                </button>
                            </div>
                        )}
                    </div>

                    {result && !isPlaying && (
                        <div className={`text-[10px] font-bold text-center py-1 rounded border ${result.success
                            ? (isHackerMode ? 'bg-[#ff0040]/10 border-[#ff0040]/30 text-[#ff0040]' : 'bg-red-500/10 border-red-500/20 text-red-400')
                            : (isHackerMode ? 'bg-[#00ff41]/10 border-[#00ff41]/30 text-[#00ff41]' : 'bg-green-500/10 border-green-500/20 text-green-400')
                            }`}>
                            {result.success ? '‚ö†Ô∏è EXPLOIT SUCCESSFUL' : 'üõ°Ô∏è ATTACK MITIGATED'}
                        </div>
                    )}

                    <div className="rounded-lg overflow-hidden border border-white/5 bg-black/20">
                        <AttackVisualization result={result} isScanning={isScanning} currentStepIndex={currentStepIndex} />
                    </div>
                </div>

                {/* 3. Detailed Results */}
                {result && (
                    <div className={`rounded-lg overflow-hidden border transition-colors ${isHackerMode ? 'border-[#00ff41]/30' : 'border-white/5'}`}>
                        <div className={`px-3 py-2 border-b flex items-center gap-2 ${isHackerMode ? 'bg-[#0d1117] border-[#00ff41]/30' : 'bg-white/5 border-white/5'}`}>
                            <Terminal size={12} className={isHackerMode ? 'text-[#00ff41]' : 'text-[#ccc]'} />
                            <span className={`text-[10px] font-bold uppercase tracking-wider ${isHackerMode ? 'text-[#00ff41]' : 'text-[#ccc]'}`}>Attack Log</span>
                        </div>

                        <div className={`p-3 font-mono text-[11px] space-y-4 ${isHackerMode ? 'bg-[#0a0a0a]' : 'bg-[#1a1a1a]'}`}>

                            {/* Attack Steps */}
                            <div className="space-y-3">
                                {result.attack_chain.map((step, i) => (
                                    <div key={i} className="flex gap-3 items-start animate-in fade-in slide-in-from-left-2 duration-300" style={{ animationDelay: `${i * 100}ms` }}>
                                        <span className={`text-[9px] mt-0.5 opacity-50 ${isHackerMode ? 'text-[#00ff41]' : 'text-[#888]'}`}>
                                            [{String(step.step_number).padStart(2, '0')}]
                                        </span>
                                        <div className="flex-1">
                                            <div className={`font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-[#ccc]'}`}>
                                                {step.action}
                                            </div>
                                            <div className={`text-[11px] mt-1 pl-2 border-l-2 ${step.status === 'Success'
                                                ? (isHackerMode ? 'text-[#ff0040] border-[#ff0040]/50' : 'text-red-400 border-red-400/30')
                                                : 'text-green-400 border-green-400/30'
                                                }`}>
                                                {step.result}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Impact Analysis */}
                            {result.success && (
                                <div className={`mt-4 p-3 border border-dashed rounded bg-opacity-10 ${isHackerMode ? 'border-[#ff0040] bg-[#ff0040]' : 'border-red-500/30 bg-red-500'}`}>
                                    <div className={`flex items-center gap-2 mb-2 font-bold ${isHackerMode ? 'text-[#ff0040]' : 'text-red-400'}`}>
                                        <Bug size={14} />
                                        IMPACT ANALYSIS
                                    </div>
                                    <div className={`text-[11px] space-y-1 ${isHackerMode ? 'text-[#ff0040]/90' : 'text-red-300'}`}>
                                        <p><span className="opacity-50">TYPE:</span> {result.attack_type}</p>
                                        <p><span className="opacity-50">IMPACT:</span> {result.impact_description}</p>
                                        {result.data_exposed && <p><span className="opacity-50">EXPOSED:</span> {result.data_exposed}</p>}
                                        <p><span className="opacity-50">CWE:</span> {result.cwe}</p>
                                    </div>
                                </div>
                            )}

                            {/* Mitigation */}
                            <div className={`mt-2 p-3 border border-dashed rounded bg-opacity-10 ${isHackerMode ? 'border-[#00ff41] bg-[#00ff41]' : 'border-green-500/30 bg-green-500'}`}>
                                <div className={`flex items-center gap-2 mb-2 font-bold ${isHackerMode ? 'text-[#00ff41]' : 'text-green-400'}`}>
                                    <ShieldCheck size={14} />
                                    REMEDIATION
                                </div>
                                <div className={`text-[11px] leading-relaxed ${isHackerMode ? 'text-[#00ff41]/90' : 'text-green-300'}`}>
                                    {result.mitigation}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </GlassPanel>
    );
}
